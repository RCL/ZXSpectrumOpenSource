Краткое руководство по использованию мини-движка diver30.

Сборка
======

Войти в каталог output и запустить build.bat / build.sh

Карта памяти
============

Основная часть движка - это кернель, размещённый по адресу #5b00 и занимающий до #6000 (в реальности он может занимать меньше). Там же находится и стек (256 байт).
Часть кода и ресурсов (шрифт и скрипт) движка лежит на 7 странице непосредственно за экраном, занимая пару килобайт.
Таблица прерываний лежит в быстрой памяти с адреса #be00 и до #bfff

Остальная память (#6000-#bdff, #c000-#ffff), а также все страницы (с оговоркой на вышеупомянутые ресурсы в 7-й) доступна для эффектов.

При сборке движка будут напечатаны детали типа

> ---- Kernel memory breakdown ----
> Kernel starts at 0x5B00 and takes 0x0414, 1044 bytes.
>     Of which, main thread code takes 0x02AE, 686 bytes,
>     interrupt code takes 0x005E, 94 bytes,
>     and stack takes 0x0100, 256 bytes (top of the stck is at 0x5F14, 24340)
> First available address for the effects is 0x5F14, 24340
> Last available address for the effect is 0xBDFF, 48639
> Maximum continuous effect size is 0x5EEC, 24300
> ---------------------------------

> ---- Page memory breakdown ----
> Page1 takes 0x34F4, 13556 bytes, free: 0x0B0C, 2828 bytes.
> Page3 takes 0x124F, 4687 bytes, free: 0x2DB1, 11697 bytes.
> Page4 takes 0x1A61, 6753 bytes, free: 0x259F, 9631 bytes.
> Page6 takes 0x2802, 10242 bytes, free: 0x17FE, 6142 bytes.
> Page7 takes 0x0492, 1170 bytes, free: 0x3B6E, 15214 bytes.
> ---------------------------------


Принцип работы
==============

Движок состоит из главного цикла, постоянно исполняющего скрипт, и обработчика прерываний.

Обработчик прерываний считает кадры, попутно играя музыку и вызывая процедуру по указанному адресу (если он установлен из скрипта, по умолчанию адрес = 0, и ничего не вызывается). 
Предполагается, но никак не проверяется и не наказывается, что процедура (назовём её "эффект на прерываниях") выполнится за время, меньшее инта. 
Иными словами, ожидается, что эффект отрисует кадр и выйдет.

Главный цикл постоянно исполняет команды скрипта, из которой наиболее частая - "жди такого-то кадра". Во время ожидания главный цикл тоже может вызывать процедуру 
по уже своему адресу (опять же если он установлен, по умолчанию адрес = 0, так что ничто не зовётся), назовём её "эффект на главном потоке".
Главный цикл будет вызывать эффект на главном потоке очень часто, в цикле ожидания кадра, никак не синхронизируясь с прерываниями. 
Если эффект хочет с ними синхронизироваться, он сам должен исполнить HALT. В целом ожидается, что эффект отрисует кадр (за сколько прерываний сколько хочет) и выйдет.

Пример скрипта:

	db CMD_SET_MAINTHREAD_EFFECT		; команда установки адреса процедуры для главного цикла
	db GG_BOLT_PAGE				; номер страницы, на которую нужно переключиться перед вызовом
	dw gg_bolt					; адрес процедуры

	db CMD_WAIT_TICK			; команда ожидания кадра с номером 750 (т.е. 15-той секунды)
	dw 750


Обратите внимание на важность этих команд ожидания! Если убрать из скрипта все команды ожидания, он исполнится с максимальной скоростью, а вызовов установленного эффекта главного потока может вообще не произойти (т.к. он вызывается только при ожидании на кадр и ещё при печати).

----

Скрипт содержит следующие команды (вообще говоря их число и функциональность не фиксированны, и в разных демах я добавлял разные):

CMD_WAIT_TICK_RELATIVE - ожидание кадра, относительно предыдущего (т.е. позволяет написать команду не "жди 15-той секунды", а "жди следующие 15 секунд").

CMD_CALL - вызов процедуры. Конечно же во время исполнения процедуры сам скрипт исполняться не будет (только обработчик). Так можно вызвать долгий инициализатор эффекта или даже забрать контроль у скрипта 
           и самому организовать новый главный цикл в этой процедуре (если эффект уже был написан так).
		   
CMD_SHOWIMAGE - распаковка картинки пожатой ZX0 на экран. Хоть это можно было бы организировать самому используя CMD_CALL, движок, будучи в оригинале движком слайдшоу, содержит эту функциональность.

CMD_PRINT - печать строки на прерываниях. Снова, специализированный код, унаследованный от слайдшоу. Использовать необязательно. Принтер на прерываниях работает перед вызовом эффекта на прерываниях.

CMD_LOOP - переход на начало скрипта со сбросом номера кадра в 0 (обычно я сбрасываю и музыку, но в grongift я сейчас это убрал).

Для полного списка команд и их аргументов, см. script.inc

Контроль над ресурсами компьютера
==============

Движок осуществляет минимальный контроль над единственным, но немаловажным, аспектом - переключением страниц. Оно должно происходить через вызовы процедуры bank_switch_push и иметь парный вызов bank_switch_pop. Это нужно потому, что
движок в процессе работы сам переключает туда-сюда страницы (например на прерываниях), поэтому если банк включен без его ведома, то он не восстановит предыдущую.  Стек страниц небольшой (16 элементов), и на данный момент
его переполнение или исчерпание не проверяется.

Движок на данный момент никак не арбитрирует какой экран видим, и это надо будет доработать чтобы переключение страниц не щёлкало экраны.

-RCL
